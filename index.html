<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Lager App ‚Äì Inventur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root{
      --bg:#000;
      --bg-elevated:#111319;
      --border:#2a2f3b;
      --accent:#2ecc71;
      --accent-soft:rgba(46,204,113,0.15);
      --danger:#e74c3c;
      --text:#f5f5f7;
      --text-muted:#9aa0b5;
      --radius:8px;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      padding:0.8rem;
      font-family:system-ui,-apple-system,"SF Pro Text","Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#1c2230 0,#05060a 60%);
      color:var(--text);
    }

    h1{
      margin:0 0 0.6rem 0;
      font-size:1rem;
      text-align:center;
    }

    #stats{
      background:var(--bg-elevated);
      border-radius:var(--radius);
      border:1px solid var(--border);
      padding:0.4rem 0.6rem;
      font-size:0.75rem;
      display:flex;
      flex-wrap:wrap;
      gap:0.8rem;
      margin-bottom:0.6rem;
    }
    #stats span{color:var(--text-muted);}
    #stats b{color:var(--text);}

    .controls,.filters{
      display:flex;
      flex-wrap:wrap;
      gap:0.4rem;
      margin-bottom:0.5rem;
    }

    button{
      cursor:pointer;
      padding:0.35rem 0.8rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#141922;
      color:var(--text);
      font-size:0.8rem;
      display:inline-flex;
      align-items:center;
      gap:0.25rem;
    }

    button.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#041208;
      font-weight:600;
    }

    textarea{
      padding:0.35rem 0.4rem;
      border-radius:6px;
      border:1px solid var(--border);
      background:#0e1118;
      color:var(--text);
      font-size:0.8rem;
      resize:vertical;
    }

    .table-wrapper{
      background:var(--bg-elevated);
      border-radius:var(--radius);
      border:1px solid var(--border);
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:950px;
    }
    th,td{
      padding:0.12rem 0.25rem;
      border-bottom:1px solid #222735;
      font-size:0.5rem;
      white-space:nowrap;
    }
    th{
      background:#1b202c;
      color:var(--text-muted);
      position:sticky;
      top:0;
      z-index:1;
    }

    dialog{
      background:#11141c;
      border:1px solid var(--border);
      color:var(--text);
      border-radius:var(--radius);
      padding:0.9rem;
      width:95%;
      max-width:420px;
    }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:0.6rem;
    }
    .form-grid label{
      font-size:0.75rem;
      display:flex;
      flex-direction:column;
      gap:0.2rem;
    }
    .full-width{grid-column:1/-1;}

  </style>
</head>

<body>
  <h1>Lager App ‚Äì Inventur</h1>

  <div id="stats">
    <span>Artikel-Arten: <b id="statCount">0</b></span>
    <span>Artikel gesamt: <b id="statQty">0</b></span>
    <span>Gesamt-Einkaufspreis: <b id="statTotal">0,00 ‚Ç¨</b></span>
  </div>

  <section class="controls">
    <button class="primary" id="btnAdd">+ Artikel</button>

    <label class="btn-like">
      Backup importieren (JSON)
      <input type="file" id="inputImport" accept="application/json">
    </label>

    <button id="btnExportJson">Backup exportieren (JSON)</button>
    <button id="btnPrint">Inventurliste drucken</button>
  </section>

  <section class="filters">
    <input id="search" type="search" placeholder="Suche‚Ä¶">
    <select id="filterFlag">
      <option value="all">Alle</option>
      <option value="flagged">Markierte</option>
    </select>
  </section>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>‚òÖ</th>
          <th>Art.-Nr.</th>
          <th>Name</th>
          <th>Zustand</th>
          <th>Gr√∂√üe</th> <!-- NEU -->
          <th>Wo gekauft</th>
          <th>Menge</th>
          <th>Preis/Stk (‚Ç¨)</th>
          <th>Gesamt (‚Ç¨)</th>
          <th>Kaufdatum</th>
          <th>Foto</th>
          <th>Notiz</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- Artikel-Dialog -->
  <dialog id="itemDialog">
    <form id="itemForm" class="form-grid" onsubmit="return false;">
      <label>
        Artikelnummer
        <input id="itemNumber">
      </label>

      <label>
        Kaufdatum
        <input id="itemDate" type="date">
      </label>

      <label class="full-width">
        Artikelname
        <input id="itemName" required>
      </label>

      <label>
        Zustand
        <select id="itemCondition">
          <option value="">‚Äì bitte w√§hlen ‚Äì</option>
          <option value="Neu">Neu</option>
          <option value="Wie neu">Wie neu</option>
          <option value="Gebraucht">Gebraucht</option>
        </select>
      </label>

      <label>
        Gr√∂√üe
        <input id="itemSize">    <!-- üÜï Gr√∂√üe -->
      </label>

      <label>
        Wo gekauft
        <input id="itemStore">
      </label>

      <label>
        Menge
        <input id="itemQty" type="number" min="0" value="1">
      </label>

      <label>
        Einkaufspreis (‚Ç¨)
        <input id="itemPrice" type="number" step="0.01" min="0">
      </label>

      <label class="full-width">
        Notiz
        <textarea id="itemNote" rows="3"></textarea>
      </label>

      <label class="full-width">
        Foto
        <input id="itemPhoto" type="file" accept="image/*">
        <span id="itemPhotoInfo" class="small-hint">Kein Foto ausgew√§hlt</span>
      </label>

      <label>
        <input id="itemFlagged" type="checkbox">
        Markieren
      </label>

      <div class="dialog-menu full-width">
        <button type="button" id="btnCancelItem">Abbrechen</button>
        <button type="button" class="primary" id="btnSaveItem">Speichern</button>
      </div>
    </form>
  </dialog>
    <!-- Foto-Dialog -->
  <dialog id="photoDialog">
    <div class="dialog-photo-content">
      <img id="photoDialogImg" alt="Artikel-Foto">
      <div class="dialog-menu">
        <button type="button" id="btnOpenPhoto" class="primary">Bild √∂ffnen (Speichern m√∂glich)</button>
        <button type="button" id="btnClosePhoto" class="primary">Schlie√üen</button>
      </div>
    </div>
  </dialog>

  <!-- Notiz-Dialog -->
  <dialog id="noteDialog">
    <h3>Notiz</h3>
    <pre id="noteDialogText" style="white-space:pre-wrap;font-size:0.75rem;"></pre>
    <div class="dialog-menu">
      <button type="button" id="btnCloseNote" class="primary">Schlie√üen</button>
    </div>
  </dialog>


  <script>
    document.addEventListener("DOMContentLoaded", () => {

      const STORAGE_KEY = "lager-app-simple-v1";
      let items = [];
      let currentId = null;
      let tempPhotoDataUrl = null;

      const tbody = document.getElementById("tbody");
      const itemDialog = document.getElementById("itemDialog");
      const itemForm = document.getElementById("itemForm");

      const photoDialog = document.getElementById("photoDialog");
      const photoDialogImg = document.getElementById("photoDialogImg");

      const noteDialog = document.getElementById("noteDialog");
      const noteDialogText = document.getElementById("noteDialogText");

      const statCount = document.getElementById("statCount");
      const statQty = document.getElementById("statQty");
      const statTotal = document.getElementById("statTotal");

      /* Daten laden */
      loadData();
      render();

      /* Buttons */
      document.getElementById("btnAdd").onclick = () => openItemDialog(null);
      document.getElementById("btnCancelItem").onclick = () => itemDialog.close();
      document.getElementById("btnSaveItem").onclick = () => saveItem();

      document.getElementById("btnExportJson").onclick = () => exportJson(items);
      document.getElementById("btnPrint").onclick = () => printInventur(items);

      document.getElementById("btnClosePhoto").onclick = () => photoDialog.close();
      document.getElementById("btnOpenPhoto").onclick = () => {
        if (photoDialogImg.src) window.open(photoDialogImg.src, "_blank");
      };

      document.getElementById("btnCloseNote").onclick = () => noteDialog.close();

      document.getElementById("search").oninput = () => render();
      document.getElementById("filterFlag").onchange = () => render();

      document.getElementById("inputImport").onchange = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        try {
          const data = await importJson(file);
          if (Array.isArray(data)) {
            items = data;
            saveData();
            render();
            alert("Backup importiert.");
          } else {
            alert("Ung√ºltiges JSON-Format.");
          }
        } catch (err) {
          console.error(err);
          alert("Fehler beim Import.");
        }
        e.target.value = "";
      };

      /* Fotoauswahl */
      document.getElementById("itemPhoto").addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        const info = document.getElementById("itemPhotoInfo");
        if (!file) {
          tempPhotoDataUrl = null;
          info.textContent = "Kein Foto ausgew√§hlt";
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          tempPhotoDataUrl = reader.result;
          info.textContent = "Foto ausgew√§hlt";
        };
        reader.readAsDataURL(file);
      });
            /* Tabellenaktionen */
      tbody.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if (!id || !action) return;

        const item = items.find(i => i.id === id);
        if (!item) return;

        switch (action) {
          case "flag":
            item.flagged = !item.flagged;
            saveData();
            render();
            break;

          case "edit":
            openItemDialog(id);
            break;

          case "photo":
            if (item.photoDataUrl) {
              photoDialogImg.src = item.photoDataUrl;
              photoDialog.showModal();
            }
            break;

          case "note":
            if (item.note) {
              noteDialogText.textContent = item.note;
              noteDialog.showModal();
            }
            break;

          case "delete":
            if (confirm("Diesen Artikel wirklich l√∂schen?")) {
              items = items.filter(i => i.id !== id);
              saveData();
              render();
            }
            break;
        }
      });

      /* Menge direkt editieren */
      document.addEventListener("input", (e) => {
        if (!e.target.classList.contains("qty-input")) return;
        const id = e.target.dataset.id;
        const value = Number(e.target.value);
        const item = items.find(i => i.id === id);
        if (!item) return;

        item.quantity = isNaN(value) ? 0 : value;
        saveData();
        render();
      });


      /* Dialog √∂ffnen */
      function openItemDialog(id) {
        currentId = id;
        tempPhotoDataUrl = null;
        itemForm.reset();
        document.getElementById("itemPhotoInfo").textContent = "Kein Foto ausgew√§hlt";

        // beim Bearbeiten Daten einf√ºgen
        if (id) {
          const item = items.find(i => i.id === id);
          if (item) {
            setValue("itemNumber", item.articleNumber);
            setValue("itemDate", item.purchaseDate);
            setValue("itemName", item.name);
            setValue("itemCondition", item.condition);
            setValue("itemStore", item.store);
            setValue("itemSize", item.size);
            setValue("itemQty", item.quantity);
            setValue("itemPrice", item.price);
            setValue("itemNote", item.note);

            const flagEl = document.getElementById("itemFlagged");
            if (flagEl) flagEl.checked = !!item.flagged;

            if (item.photoDataUrl) {
              document.getElementById("itemPhotoInfo").textContent = "Foto gespeichert (optional neues w√§hlen)";
            }
          }
        }
        itemDialog.showModal();
      }


      /* Speichern */
      function saveItem() {
        const name = getValue("itemName").trim();
        if (!name) {
          alert("Bitte einen Artikelnamen eingeben.");
          return;
        }

        let item = currentId ? items.find(i => i.id === currentId) : null;
        if (!item) {
          item = { id: crypto.randomUUID() };
          items.push(item);
        }

        item.articleNumber = getValue("itemNumber").trim();
        item.purchaseDate = getValue("itemDate");
        item.name = name;
        item.condition = getValue("itemCondition");
        item.store = getValue("itemStore").trim();
        item.size = getValue("itemSize").trim();
        item.quantity = Number(getValue("itemQty") || 0);
        item.price = Number(getValue("itemPrice") || 0);
        item.note = getValue("itemNote").trim();
        item.flagged = document.getElementById("itemFlagged").checked;

        if (tempPhotoDataUrl) {
          item.photoDataUrl = tempPhotoDataUrl;
        }

        saveData();
        render();
        itemDialog.close();
      }


      /* Daten laden & speichern */
      function loadData() {
        try {
          items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch {
          items = [];
        }
      }

      function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      }


      /* Rendering */
      function render() {
        tbody.innerHTML = "";

        const search = document.getElementById("search").value.toLowerCase();
        const filterFlag = document.getElementById("filterFlag").value;

        const filtered = items.filter(i => {
          if (filterFlag === "flagged" && !i.flagged) return false;

          const hay = `
            ${i.name || ""}
            ${i.articleNumber || ""}
            ${i.condition || ""}
            ${i.store || ""}
            ${i.size || ""}
            ${i.note || ""}
          `.toLowerCase();

          return hay.includes(search);
        });

        if (!filtered.length) {
          tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:0.3rem;">Keine Artikel</td></tr>';
          updateStats();
          return;
        }

        for (const item of filtered) {
          const qty = Number(item.quantity || 0);
          const total = qty * Number(item.price || 0);

          const tr = document.createElement("tr");
          if (item.flagged) tr.classList.add("flagged");

          tr.innerHTML = `
            <td>${item.flagged ? "‚≠ê" : ""}</td>
            <td>${escapeHtml(item.articleNumber || "")}</td>
            <td>${escapeHtml(item.name || "")}</td>
            <td>${escapeHtml(item.condition || "")}</td>
            <td>${escapeHtml(item.store || "")}</td>
            <td>${escapeHtml(item.size || "")}</td>

            <td>
              <input type="number" min="0" value="${qty}" class="qty-input" data-id="${item.id}">
              ${qty <= 1 ? '<span class="badge-low">niedrig</span>' : ""}
            </td>

            <td>${Number(item.price || 0).toFixed(2).replace(".", ",")}</td>
            <td>${total.toFixed(2).replace(".", ",")}</td>
            <td>${escapeHtml(item.purchaseDate || "")}</td>

            <td>${item.photoDataUrl ? "üì∑" : "‚Äì"}</td>

            <td>
              <button class="icon-btn" data-action="flag" data-id="${item.id}" title="Markieren">‚≠ê</button>
              <button class="icon-btn" data-action="edit" data-id="${item.id}" title="Bearbeiten">‚úèÔ∏è</button>
              <button class="icon-btn" data-action="photo" data-id="${item.id}" title="Foto anzeigen">üì∑</button>
              <button class="icon-btn" data-action="note" data-id="${item.id}" title="Notiz">üìù</button>
              <button class="icon-btn danger" data-action="delete" data-id="${item.id}" title="L√∂schen">üóëÔ∏è</button>
            </td>
          `;

          tbody.appendChild(tr);
        }

        updateStats();
      }


      function updateStats() {
        const count = items.length;
        const totalQty = items.reduce((s, i) => s + Number(i.quantity || 0), 0);
        const totalPrice = items.reduce(
          (s, i) => s + Number(i.quantity || 0) * Number(i.price || 0),
          0
        );

        statCount.textContent = count;
        statQty.textContent = totalQty;
        statTotal.textContent = totalPrice.toFixed(2).replace(".", ",") + " ‚Ç¨";
      }


      /* Druck */
      function printInventur() {
        window.print();
      }


      /* JSON Export/Import */
      function exportJson(list) {
        const blob = new Blob([JSON.stringify(list, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "lager-backup.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importJson(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            try { resolve(JSON.parse(reader.result)); }
            catch (e) { reject(e); }
          };
          reader.onerror = reject;
          reader.readAsText(file);
        });
      }


      /* Helpers */
      function getValue(id) { return document.getElementById(id).value; }
      function setValue(id, v) { document.getElementById(id).value = v ?? ""; }
      function escapeHtml(str) {
        return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }

    });
  </script>
